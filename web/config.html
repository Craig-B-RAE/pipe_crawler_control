<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawler Configuration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: #ffffff;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        h1 {
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 22px;
            text-align: center;
        }
        .subtitle {
            color: #86868b;
            margin-bottom: 25px;
            font-size: 13px;
            text-align: center;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #007aff;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .back-link:hover { text-decoration: underline; }
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .network-info {
            display: grid;
            gap: 8px;
        }
        .network-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #f5f5f7;
            border-radius: 8px;
            font-size: 13px;
        }
        .network-item .label { color: #86868b; }
        .network-item .value {
            color: #1d1d1f;
            font-weight: 500;
            font-family: -apple-system, monospace;
        }
        .network-item .value.none {
            color: #c0c0c0;
            font-style: italic;
        }
        .crawler-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .crawler-option {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .crawler-option:hover { border-color: #007aff; }
        .crawler-option.selected {
            border-color: #007aff;
            background: #f0f7ff;
        }
        .crawler-option.current {
            border-color: #34c759;
            background: #e8f5e9;
        }
        .crawler-option input[type="radio"] { display: none; }
        .crawler-name {
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
        }
        .crawler-id {
            font-size: 12px;
            color: #86868b;
            font-family: monospace;
        }
        .form-group { margin-bottom: 12px; }
        .form-label {
            display: block;
            font-size: 12px;
            color: #86868b;
            margin-bottom: 5px;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        .form-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }
        .form-hint {
            font-size: 10px;
            color: #86868b;
            margin-top: 3px;
        }
        .btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            width: 100%;
            color: #ffffff;
            background: #007aff;
        }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary {
            color: #007aff;
            background: #f0f7ff;
        }
        .btn-secondary:hover { background: #e0efff; }
        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }
        .btn-danger {
            width: 100%;
            color: #ffffff;
            background: #ff3b30;
        }
        .btn-danger:hover { background: #d63028; }
        .reboot-notice {
            background: #fff3e0;
            color: #e65100;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.4;
        }
        .hotspot-info {
            background: #f5f5f7;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
        }
        .hotspot-info .label { color: #86868b; }
        .hotspot-info .value {
            color: #1d1d1f;
            font-weight: 500;
            margin-left: 8px;
        }
        .access-denied {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .error.show { display: block; }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .success.show { display: block; }
        .wifi-list {
            max-height: 250px;
            overflow-y: auto;
        }
        .wifi-network {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: #f5f5f7;
            cursor: pointer;
            transition: background 0.2s;
        }
        .wifi-network:hover { background: #e8e8ed; }
        .wifi-network.connected { background: #e8f5e9; }
        .wifi-info { flex: 1; }
        .wifi-ssid {
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
        }
        .wifi-details {
            font-size: 11px;
            color: #86868b;
            margin-top: 2px;
        }
        .wifi-signal {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }
        .signal-bar {
            width: 4px;
            background: #c0c0c0;
            border-radius: 1px;
        }
        .signal-bar.active { background: #34c759; }
        .signal-bar:nth-child(1) { height: 4px; }
        .signal-bar:nth-child(2) { height: 8px; }
        .signal-bar:nth-child(3) { height: 12px; }
        .signal-bar:nth-child(4) { height: 16px; }
        .scan-btn { margin-bottom: 12px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 350px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons .btn { flex: 1; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #86868b;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
            Back to Control
        </a>

        <h1>Crawler Configuration</h1>
        <p class="subtitle">Network and system settings</p>

        <div id="errorMsg" class="error"></div>
        <div id="successMsg" class="success"></div>

        <!-- Network Status -->
        <div class="section">
            <div class="section-title">Network Status</div>
            <div class="network-info">
                <div class="network-item">
                    <span class="label">Hostname</span>
                    <span class="value" id="hostnameDisplay">--</span>
                </div>
                <div class="network-item">
                    <span class="label">WiFi</span>
                    <span class="value" id="wifiDisplay">--</span>
                </div>
                <div class="network-item">
                    <span class="label">Ethernet</span>
                    <span class="value" id="ethernetDisplay">--</span>
                </div>
            </div>
        </div>

        <!-- Crawler Selection -->
        <div class="section">
            <div class="section-title">Crawler Type</div>
            <div class="crawler-options" id="crawlerOptions">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <!-- Hotspot Settings Section -->
        <div class="section" style="margin-top: 20px; text-align: center;">
            <div class="section-title">WiFi Hotspot</div>
            <div class="hotspot-info" style="display: inline-block;">
                <span class="label">Current SSID:</span>
                <span class="value" id="currentSsidDisplay">--</span>
            </div>
            <div>
                <button type="button" class="btn btn-secondary" onclick="showHotspotAuth()" style="margin-top: 12px;">
                    Change Hotspot Settings
                </button>
            </div>
        </div>

        <!-- Reboot Section -->
        <div class="section" style="margin-top: 20px; text-align: center;">
            <div class="section-title">System Control</div>
            <div class="reboot-notice" style="text-align: center;">
                Changes will be saved and applied after reboot.
            </div>
            <button type="button" class="btn btn-danger" onclick="saveAndReboot()">Reboot and Save Changes</button>
        </div>

        <!-- WiFi Scanner -->
        <div class="section" style="margin-top: 25px; text-align: center;">
            <div class="section-title">Available WiFi Networks</div>
            <button type="button" class="btn btn-secondary btn-small scan-btn" onclick="scanWifi()">
                Scan Networks
            </button>
            <div id="wifiList" class="wifi-list" style="text-align: left;">
                <div class="loading" style="text-align: center;">Click "Scan Networks" to find available networks</div>
            </div>
        </div>
    </div>

    <!-- WiFi Password Modal -->
    <div id="wifiModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Connect to <span id="modalSsid"></span></div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="wifiPassword" class="form-input" placeholder="Enter WiFi password">
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeWifiModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="connectWifi()">Connect</button>
            </div>
        </div>
    </div>

    <!-- Hotspot Auth Modal -->
    <div id="hotspotAuthModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Authentication Required</div>
            <div class="form-group">
                <label class="form-label">Enter admin password to change hotspot settings</label>
                <input type="password" id="hotspotAuthPassword" class="form-input" placeholder="Password">
            </div>
            <div id="authDenied" class="access-denied">Access denied. Incorrect password.</div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeHotspotAuth()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="checkHotspotAuth()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Hotspot Settings Modal -->
    <div id="hotspotSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Hotspot Settings</div>
            <div class="form-group">
                <label class="form-label">Network Name (SSID)</label>
                <input type="text" id="hotspotSsid" class="form-input" maxlength="32">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="text" id="hotspotPassword" class="form-input" maxlength="63">
                <div class="form-hint">Minimum 8 characters</div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeHotspotSettings()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveHotspotSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        var currentConfig = {};
        var selectedCrawler = null;
        var selectedSsid = '';
        var pendingHotspotSsid = null;
        var pendingHotspotPassword = null;

        var CRAWLERS = {
            'magnetic': { name: 'Magnetic Pipe Crawler', hostname: 'magnetic' },
            'xpresscan': { name: 'Xpress Scan', hostname: 'xpresscan' },
            'edgeflex': { name: 'EdgeFlex RoboClaw', hostname: 'edgeflex' },
            'edgeflex_clearlink': { name: 'EdgeFlex ClearLink', hostname: 'edgeflex' }
        };

        function loadConfig() {
            fetch('/api/config')
                .then(r => r.json())
                .then(data => {
                    currentConfig = data;
                    selectedCrawler = data.crawler_id;
                    pendingHotspotSsid = data.ssid;
                    pendingHotspotPassword = data.password;

                    // Update displays
                    document.getElementById('currentSsidDisplay').textContent = data.ssid || '--';
                    document.getElementById('hotspotSsid').value = data.ssid || '';
                    document.getElementById('hotspotPassword').value = data.password || '';

                    // Network info
                    document.getElementById('hostnameDisplay').textContent = data.network?.hostname || '--';
                    var wifi = data.network?.wifi;
                    if (wifi?.ip) {
                        document.getElementById('wifiDisplay').textContent = wifi.ip + (wifi.ssid ? ' (' + wifi.ssid + ')' : '');
                    } else {
                        document.getElementById('wifiDisplay').textContent = 'Not connected';
                        document.getElementById('wifiDisplay').classList.add('none');
                    }
                    var eth = data.network?.ethernet;
                    if (eth?.ip) {
                        document.getElementById('ethernetDisplay').textContent = eth.ip;
                    } else {
                        document.getElementById('ethernetDisplay').textContent = 'Not connected';
                        document.getElementById('ethernetDisplay').classList.add('none');
                    }

                    // Render crawler options
                    renderCrawlerOptions();
                })
                .catch(err => {
                    showError('Failed to load configuration');
                    console.error(err);
                });
        }

        function renderCrawlerOptions() {
            var container = document.getElementById('crawlerOptions');
            container.innerHTML = '';

            for (var id in CRAWLERS) {
                var crawler = CRAWLERS[id];
                var isCurrent = id === currentConfig.crawler_id;
                var isSelected = id === selectedCrawler;

                var div = document.createElement('label');
                div.className = 'crawler-option' + (isCurrent ? ' current' : '') + (isSelected ? ' selected' : '');
                div.onclick = (function(crawlerId, element) {
                    return function() { selectCrawler(crawlerId, element); };
                })(id, div);

                div.innerHTML = '<input type="radio" name="crawler_id" value="' + id + '"' + (isSelected ? ' checked' : '') + '>' +
                    '<span class="crawler-name">' + crawler.name + '</span>';

                container.appendChild(div);
            }
        }

        function selectCrawler(id, element) {
            document.querySelectorAll('.crawler-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
            selectedCrawler = id;
        }

        function saveAndReboot() {
            if (!selectedCrawler) {
                showError('Please select a crawler type');
                return;
            }

            if (!confirm('Save changes and reboot the crawler now?')) {
                return;
            }

            // First save the configuration
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    crawler_id: selectedCrawler,
                    ssid: pendingHotspotSsid,
                    password: pendingHotspotPassword
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Now reboot
                    fetch('/api/reboot', { method: 'POST' })
                        .then(r => r.json())
                        .then(rebootData => {
                            if (rebootData.success) {
                                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><div style="text-align:center;"><h2>Rebooting...</h2><p>Configuration saved. The crawler is restarting.</p><p>Please wait and reconnect.</p></div></div>';
                            } else {
                                showError('Configuration saved but reboot failed: ' + (rebootData.error || 'Unknown error'));
                            }
                        })
                        .catch(err => {
                            showError('Configuration saved but reboot failed');
                        });
                } else {
                    showError(data.error || 'Failed to save configuration');
                }
            })
            .catch(err => {
                showError('Failed to save configuration');
                console.error(err);
            });
        }

        function scanWifi() {
            var list = document.getElementById('wifiList');
            list.innerHTML = '<div class="loading">Scanning...</div>';

            fetch('/api/wifi/scan')
                .then(r => r.json())
                .then(data => {
                    if (!data.networks || data.networks.length === 0) {
                        list.innerHTML = '<div class="loading">No networks found</div>';
                        return;
                    }

                    list.innerHTML = data.networks.map(net =>
                        '<div class="wifi-network ' + (net.connected ? 'connected' : '') + '" onclick="showConnectModal(\'' + net.ssid.replace(/'/g, "\\'") + '\', ' + net.connected + ', \'' + net.security + '\')">' +
                            '<div class="wifi-info">' +
                                '<div class="wifi-ssid">' + net.ssid + (net.connected ? ' (Connected)' : '') + '</div>' +
                                '<div class="wifi-details">' + (net.security || 'Open') + '</div>' +
                            '</div>' +
                            '<div class="wifi-signal">' +
                                '<div class="signal-bars">' +
                                    '<div class="signal-bar ' + (net.signal > 0 ? 'active' : '') + '"></div>' +
                                    '<div class="signal-bar ' + (net.signal > 25 ? 'active' : '') + '"></div>' +
                                    '<div class="signal-bar ' + (net.signal > 50 ? 'active' : '') + '"></div>' +
                                    '<div class="signal-bar ' + (net.signal > 75 ? 'active' : '') + '"></div>' +
                                '</div>' +
                            '</div>' +
                        '</div>'
                    ).join('');
                })
                .catch(err => {
                    list.innerHTML = '<div class="loading">Error scanning networks</div>';
                });
        }

        function showConnectModal(ssid, connected, security) {
            if (connected) return;
            selectedSsid = ssid;
            document.getElementById('modalSsid').textContent = ssid;
            document.getElementById('wifiPassword').value = '';
            document.getElementById('wifiPassword').parentElement.style.display = security ? 'block' : 'none';
            document.getElementById('wifiModal').classList.add('show');
        }

        function closeWifiModal() {
            document.getElementById('wifiModal').classList.remove('show');
        }

        function connectWifi() {
            var password = document.getElementById('wifiPassword').value;
            closeWifiModal();

            var list = document.getElementById('wifiList');
            list.innerHTML = '<div class="loading">Connecting to ' + selectedSsid + '...</div>';

            fetch('/api/wifi/connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ssid: selectedSsid, password: password })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showSuccess('Connected to ' + selectedSsid);
                    setTimeout(function() { location.reload(); }, 2000);
                } else {
                    showError(data.message || 'Connection failed');
                    setTimeout(scanWifi, 2000);
                }
            })
            .catch(err => {
                showError('Connection failed');
                setTimeout(scanWifi, 2000);
            });
        }

        function showHotspotAuth() {
            document.getElementById('hotspotAuthPassword').value = '';
            document.getElementById('authDenied').style.display = 'none';
            document.getElementById('hotspotAuthModal').classList.add('show');
            document.getElementById('hotspotAuthPassword').focus();
        }

        function closeHotspotAuth() {
            document.getElementById('hotspotAuthModal').classList.remove('show');
        }

        function checkHotspotAuth() {
            var password = document.getElementById('hotspotAuthPassword').value;
            if (password === 'Prime') {
                closeHotspotAuth();
                showHotspotSettings();
            } else {
                document.getElementById('authDenied').style.display = 'block';
                document.getElementById('hotspotAuthPassword').value = '';
                document.getElementById('hotspotAuthPassword').focus();
            }
        }

        function showHotspotSettings() {
            document.getElementById('hotspotSsid').value = pendingHotspotSsid || '';
            document.getElementById('hotspotPassword').value = pendingHotspotPassword || '';
            document.getElementById('hotspotSettingsModal').classList.add('show');
            document.getElementById('hotspotSsid').focus();
        }

        function closeHotspotSettings() {
            document.getElementById('hotspotSettingsModal').classList.remove('show');
        }

        function saveHotspotSettings() {
            var ssid = document.getElementById('hotspotSsid').value.trim();
            var password = document.getElementById('hotspotPassword').value.trim();

            if (ssid.length < 1 || ssid.length > 32) {
                alert('SSID must be 1-32 characters');
                return;
            }
            if (password.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            pendingHotspotSsid = ssid;
            pendingHotspotPassword = password;
            document.getElementById('currentSsidDisplay').textContent = ssid;

            closeHotspotSettings();
            showSuccess('Hotspot settings updated. Click "Reboot and Save Changes" to apply.');
        }

        function showError(msg) {
            var el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
            document.getElementById('successMsg').classList.remove('show');
            setTimeout(function() { el.classList.remove('show'); }, 5000);
        }

        function showSuccess(msg) {
            var el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('show');
            document.getElementById('errorMsg').classList.remove('show');
            setTimeout(function() { el.classList.remove('show'); }, 5000);
        }

        // Allow Enter key in modals
        document.getElementById('hotspotAuthPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkHotspotAuth();
        });
        document.getElementById('wifiPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') connectWifi();
        });

        // Load config on page load
        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html>
