<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d1d1f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pipe Crawler">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <title>Starting Up...</title>
    <script>
        // Redirect immediately if splash already shown this session — MUST be in <head> to prevent flash
        (function() {
            var isDebug = window.location.search.indexOf('debug=true') !== -1;
            if (!isDebug) {
                try {
                    if (sessionStorage.getItem('splashComplete') === 'true') {
                        window.location.replace('/');
                    }
                } catch (e) {}
            }
        })();
    </script>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/base.css">
    <style>
        /* Hide body until ready to prevent FOUC */
        body.page-utility {
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        body.page-utility.loaded {
            opacity: 1;
        }
        .logo {
            max-width: 350px;
            width: 80%;
            margin-bottom: 50px;
        }
        .status-text {
            font-size: 26px;
            font-weight: 600;
            margin-bottom: 35px;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }
        .status-text.ready {
            color: var(--status-ok);
        }

        /* Progress bar container */
        .progress-container {
            width: 100%;
            margin-bottom: 25px;
        }
        .progress-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .progress-bar-outer {
            flex: 1;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00C8D4 0%, #00B8C4 100%);
            border-radius: 6px;
            transition: width 0.3s ease-out;
            box-shadow: 0 1px 3px rgba(0, 200, 212, 0.4);
        }
        .progress-percent {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-cyan);
            min-width: 45px;
            text-align: right;
        }

        /* Status message below progress bar */
        .status-message {
            font-size: 15px;
            color: var(--text-tertiary);
            margin-top: 20px;
            min-height: 20px;
            transition: opacity 0.3s ease;
        }
        .status-message.fading {
            opacity: 0;
        }

        /* Continue button - hidden initially */
        .continue-button {
            display: none;
            background: var(--accent-cyan);
            color: #FFFFFF;
            border: none;
            padding: 14px 50px;
            font-size: 17px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 30px;
            font-family: inherit;
            letter-spacing: -0.3px;
            touch-action: manipulation;
        }
        .continue-button:hover {
            background: var(--accent-cyan-hover);
            transform: scale(1.02);
        }
        .continue-button:active {
            transform: scale(0.98);
        }
        .continue-button.show {
            display: inline-block;
        }
        .continue-button:disabled {
            background: var(--border-color);
            cursor: wait;
        }

        /* Debug banner */
        .debug-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--status-warning);
            color: #000;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            display: none;
            z-index: 100;
        }
        .debug-banner a {
            color: #000;
            margin-left: 15px;
        }

        /* Error state */
        .error-message {
            color: var(--status-error);
            font-size: 14px;
            margin-top: 15px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
    </style>
</head>
<body class="page-utility">
    <!-- Inline theme initialization to prevent flash -->
    <script>
        (function() {
            var savedTheme = localStorage.getItem('crawler-theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <div class="debug-banner" id="debugBanner">
        DEBUG MODE - Boot Splash Preview
        <a href="/config.html">Back to Config</a>
    </div>

    <div class="container">
        <img src="/images/prime_inspections_logo.png" alt="Prime Inspections Inc." class="logo">

        <div class="status-text" id="statusText">Starting up...</div>

        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-bar-outer">
                    <div class="progress-bar-inner" id="progressBar"></div>
                </div>
                <div class="progress-percent" id="progressPercent">0%</div>
            </div>

            <div class="status-message" id="statusMessage">Starting system services...</div>
        </div>

        <button class="continue-button" id="continueButton" onclick="handleContinue()">
            Continue
        </button>

        <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
        // Global error handler for debugging Safari issues
        window.onerror = function(msg, url, line, col, error) {
            console.error('JS Error: ' + msg + ' at line ' + line);
            return false;
        };

        // Fade in body once loaded
        document.body.classList.add('loaded');

        // Configuration
        var STARTUP_DURATION = 30000; // 30 seconds - must match MINIMUM_BOOT_TIME in crawler_ui.py
        var UPDATE_INTERVAL = 100;    // Update every 100ms for smooth progress
        var MESSAGE_INTERVAL = 3500;  // Show new message every 3.5 seconds
        var isDebugMode = window.location.search.indexOf('debug=true') !== -1;

        // State
        var startTime = Date.now();
        var timerComplete = false;
        var securityCheckResult = null;
        var currentMessageIndex = 0;
        var lastMessageTime = 0;

        // Real messages (always include some of these)
        var realMessages = [
            "Starting system services...",
            "Initializing components...",
            "Connecting to network...",
            "Loading configuration...",
            "Preparing motors...",
            "Calibrating sensors...",
            "Checking connections...",
            "Loading drivers...",
            "Starting ROS2 nodes...",
            "Initializing web interface...",
            "Verifying hardware...",
            "Loading motor parameters...",
            "Establishing communication...",
            "Running diagnostics..."
        ];

        // Funny messages (randomly mixed in — light tech humor only)
        var funnyMessages = [
            "Reticulating splines...",
            "Charging flux capacitor...",
            "Downloading more RAM...",
            "Reversing the polarity...",
            "Calibrating the turbo encabulator...",
            "Brewing digital coffee...",
            "Untangling the cables...",
            "Warming up the hamster wheel...",
            "Convincing bits to become bytes...",
            "Polishing the pixels...",
            "Negotiating with the cloud...",
            "Almost there, promise...",
            "Any moment now...",
            "Generating random numbers... 4...",
            "It's not a bug, it's a feature...",
            "Why is it always DNS?"
        ];

        // Shuffle array using Fisher-Yates algorithm
        function shuffleArray(array) {
            var shuffled = array.slice();
            for (var i = shuffled.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = shuffled[i];
                shuffled[i] = shuffled[j];
                shuffled[j] = temp;
            }
            return shuffled;
        }

        // Generate randomized messages for this boot (40% real, 60% funny)
        function getRandomMessages(count) {
            var shuffledReal = shuffleArray(realMessages);
            var shuffledFunny = shuffleArray(funnyMessages);

            var realCount = Math.ceil(count * 0.4);
            var funnyCount = count - realCount;

            var selected = shuffledReal.slice(0, realCount).concat(shuffledFunny.slice(0, funnyCount));
            return shuffleArray(selected);
        }

        // Generate 8 messages for the 30-second boot (one every ~3.5 seconds)
        var bootMessages = getRandomMessages(8);

        // Debug mode
        if (isDebugMode) {
            document.getElementById('debugBanner').style.display = 'block';
        }

        // Set the first message immediately
        if (bootMessages.length > 0) {
            document.getElementById('statusMessage').textContent = bootMessages[0];
            currentMessageIndex = 1;
        }

        // Start the timer-based progress
        var progressInterval = setInterval(updateProgress, UPDATE_INTERVAL);

        // Also poll for security status in background (but don't affect progress)
        var securityPollInterval = setInterval(checkSecurityStatus, 2000);
        checkSecurityStatus(); // Check immediately

        function updateProgress() {
            var elapsed = Date.now() - startTime;
            var progress = Math.min((elapsed / STARTUP_DURATION) * 100, 100);

            // Update progress bar
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';

            // Update status message at regular intervals with crossfade
            if (elapsed - lastMessageTime >= MESSAGE_INTERVAL) {
                lastMessageTime = elapsed;
                if (currentMessageIndex < bootMessages.length) {
                    var msgEl = document.getElementById('statusMessage');
                    msgEl.classList.add('fading');
                    var idx = currentMessageIndex;
                    setTimeout(function() {
                        msgEl.textContent = bootMessages[idx];
                        msgEl.classList.remove('fading');
                    }, 300);
                    currentMessageIndex++;
                }
            }

            // Check if timer is complete (30 seconds)
            if (elapsed >= STARTUP_DURATION && !timerComplete) {
                timerComplete = true;
                clearInterval(progressInterval);
                onTimerComplete();
            }
        }

        function onTimerComplete() {
            // Update UI to ready state
            document.getElementById('statusText').textContent = 'Ready!';
            document.getElementById('statusText').classList.add('ready');
            document.getElementById('statusMessage').textContent = 'Ready!';
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressPercent').textContent = '100%';

            // Show the continue button
            document.getElementById('continueButton').classList.add('show');
        }

        function checkSecurityStatus() {
            fetch('/api/security/boot_status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    // Store the result for when user clicks continue
                    securityCheckResult = data;

                    // If mismatch detected during timer, still wait for timer
                    // but store the result for redirect
                })
                .catch(function(err) {
                    // Server not ready yet, will retry
                    console.log('Security check pending...');
                });
        }

        function handleContinue() {
            var btn = document.getElementById('continueButton');
            btn.disabled = true;
            btn.textContent = 'Loading...';

            // Mark splash as complete for this session (survives page refresh, clears on browser close/reboot)
            try {
                sessionStorage.setItem('splashComplete', 'true');
            } catch (e) {
                console.log('sessionStorage not available');
            }

            // Final security check before redirect
            fetch('/api/security/boot_status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.mismatch_detected) {
                        // Redirect to mismatch page
                        window.location.href = '/device_mismatch.html';
                    } else {
                        // All good - redirect to main page
                        window.location.href = '/';
                    }
                })
                .catch(function(err) {
                    // On error, try to go to main page anyway
                    // (the server will redirect to mismatch if needed)
                    showError('Could not verify security status. Redirecting...');
                    setTimeout(function() {
                        window.location.href = '/';
                    }, 1500);
                });
        }

        function showError(message) {
            var errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
    </script>
    <script src="/js/theme.js"></script>
    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(function(){});
    }
    </script>
</body>
</html>
