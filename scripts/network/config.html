<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d1d1f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pipe Crawler">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <title>Crawler Configuration</title>
    <link rel="stylesheet" href="/css/theme.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        h1 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 22px;
            text-align: center;
        }
        .subtitle {
            color: var(--text-tertiary);
            margin-bottom: 25px;
            font-size: 13px;
            text-align: center;
        }
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--status-info);
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .back-link:hover { text-decoration: underline; }
        .section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        .section:last-child {
            margin-bottom: 0;
        }
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        /* Device Bindings Table */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .device-table {
            width: 100%;
            min-width: 400px;
            border-collapse: collapse;
            background: var(--bg-primary);
            font-size: 12px;
        }
        .device-table thead tr {
            background: var(--bg-secondary);
        }
        .device-table th {
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .device-table th:nth-child(4),
        .device-table th:nth-child(5) {
            text-align: center;
        }
        .device-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
            white-space: nowrap;
        }
        .device-table td:nth-child(4),
        .device-table td:nth-child(5) {
            text-align: center;
        }
        .device-table tbody tr:last-child td {
            border-bottom: none;
        }
        .device-table tbody tr:nth-child(even) {
            background: var(--bg-secondary);
        }
        .device-table tbody tr:hover {
            background: var(--button-secondary-hover);
        }
        /* Responsive adjustments */
        @media (max-width: 480px) {
            .device-table {
                font-size: 11px;
            }
            .device-table th,
            .device-table td {
                padding: 6px 8px;
            }
        }
        .network-info {
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }
        .network-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color, rgba(128,128,128,0.15));
        }
        .network-item:last-child {
            border-bottom: none;
        }
        .network-item .label {
            color: var(--text-tertiary);
            min-width: 80px;
            flex-shrink: 0;
        }
        .network-item .value {
            color: var(--text-primary);
            font-weight: 500;
            font-family: 'SF Mono', SFMono-Regular, Menlo, monospace;
            text-align: right;
            flex: 1;
        }
        .network-item .value.none {
            color: #c0c0c0;
            font-style: italic;
        }
        .crawler-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .crawler-option {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .crawler-option:hover { border-color: var(--status-info); }
        .crawler-option.selected {
            border-color: var(--status-info);
            background: #f0f7ff;
        }
        .crawler-option.current {
            border-color: var(--status-ok);
            background: #e8f5e9;
        }
        .crawler-option input[type="radio"] { display: none; }
        .crawler-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .crawler-id {
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: monospace;
        }
        .form-group { margin-bottom: 12px; }
        .form-label {
            display: block;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--status-info);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }
        .form-hint {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 3px;
        }
        .btn {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            width: 100%;
            color: #ffffff;
            background: var(--button-primary-bg);
        }
        .btn-primary:hover { background: var(--button-primary-hover); }
        .btn-secondary {
            color: var(--status-info);
            background: #f0f7ff;
        }
        .btn-secondary:hover { background: #e0efff; }
        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }
        .btn-danger {
            width: 100%;
            color: #ffffff;
            background: var(--button-danger-bg);
        }
        .btn-danger:hover { background: var(--button-danger-hover); }
        .reboot-notice {
            background: #fff3e0;
            color: #e65100;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.4;
        }
        .hotspot-info {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
        }
        .hotspot-info .label { color: var(--text-tertiary); }
        .hotspot-info .value {
            color: var(--text-primary);
            font-weight: 500;
            margin-left: 8px;
        }
        .access-denied {
            background: var(--status-error-bg);
            color: var(--status-error);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            display: none;
        }
        .error {
            background: var(--status-error-bg);
            color: var(--status-error);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .error.show { display: block; }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .success.show { display: block; }
        .wifi-list {
            max-height: 250px;
            overflow-y: auto;
        }
        .wifi-network {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: background 0.2s;
        }
        .wifi-network:hover { background: var(--button-secondary-hover); }
        .wifi-network.connected { background: #e8f5e9; }
        .wifi-info { flex: 1; }
        .wifi-ssid {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .wifi-details {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        .wifi-signal {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .signal-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }
        .signal-bar {
            width: 4px;
            background: #c0c0c0;
            border-radius: 1px;
        }
        .signal-bar.active { background: var(--button-success-bg); }
        .signal-bar:nth-child(1) { height: 4px; }
        .signal-bar:nth-child(2) { height: 8px; }
        .signal-bar:nth-child(3) { height: 12px; }
        .signal-bar:nth-child(4) { height: 16px; }
        .scan-btn { margin-bottom: 12px; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 350px;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons .btn { flex: 1; }
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-tertiary);
        }
    </style>
</head>
<body>
    <!-- Inline theme initialization to apply saved theme - Default is LIGHT -->
    <script>
        (function() {
            var savedTheme = localStorage.getItem('crawler-theme');
            if (savedTheme === 'dark') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                if (!savedTheme) localStorage.setItem('crawler-theme', 'light');
            }
        })();
    </script>
    <div class="container">
        <div style="margin-bottom: 15px;">
            <a href="/" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
                Back to Control
            </a>
        </div>

        <h1>Crawler Configuration</h1>
        <p class="subtitle">Network and system settings</p>

        <div id="errorMsg" class="error"></div>
        <div id="successMsg" class="success"></div>

        <!-- Device Security Lock (v2 - Multi-Device) -->
        <div class="section" id="securitySection">
            <div class="section-title">Device Security</div>

            <!-- No Master Password Warning -->
            <div id="noMasterPassword" style="display: none; text-align: center; margin-bottom: 15px;">
                <p style="color: var(--text-tertiary); font-size: 13px;">
                    Master password not set. Run setup script first:
                </p>
                <p style="font-family: monospace; font-size: 12px; color: var(--text-primary); margin-top: 8px;">
                    sudo /opt/crawler/set_master_password.sh
                </p>
            </div>

            <!-- Device Bindings Table -->
            <div id="deviceBindingsSection">
                <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 8px;">Device Bindings:</div>
                <div class="table-responsive">
                    <table id="deviceBindingsTable" class="device-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Connected</th>
                                <th>Locked To</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="deviceBindingsBody">
                            <tr><td colspan="5" style="padding: 15px; text-align: center; color: var(--text-tertiary);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="deviceBindingsNote" style="display: none; font-size: 11px; color: var(--text-tertiary); font-style: italic;">
                    Note: Devices must be connected before they can be locked.
                </div>
            </div>
        </div>

        <!-- Device Lock/Unlock Modal -->
        <div id="deviceActionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.2);">
                <h3 id="modalTitle" style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Lock Device</h3>
                <input type="hidden" id="modalDevice" value="">
                <input type="hidden" id="modalAction" value="">

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Master Password:</label>
                    <input type="password" id="modalPassword" class="form-input" placeholder="Enter master password"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div id="lockConfirmSection" style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Type "LOCK" to confirm:</label>
                    <input type="text" id="modalLockConfirm" class="form-input" placeholder="LOCK"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; text-transform: uppercase; text-align: center; box-sizing: border-box;">
                </div>

                <div id="modalNote" style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 16px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;"></div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeDeviceModal()" style="flex: 1; padding: 10px;">Cancel</button>
                    <button type="button" id="modalConfirmBtn" class="btn btn-primary" onclick="executeDeviceAction()" style="flex: 1; padding: 10px;">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Program RoboClaw ID Modal -->
        <div id="programRoboclawModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 340px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Program RoboClaw ID</h3>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Custom ID (6-12 hex characters) or leave blank to auto-generate:</label>
                    <input type="text" id="programIdInput" class="form-input" placeholder="e.g., CRAWLER01 or leave blank"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; text-transform: uppercase; box-sizing: border-box;"
                           maxlength="12">
                </div>

                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 16px; padding: 8px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
                    This ID will be permanently written to the RoboClaw EEPROM and will persist across power cycles.
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeProgramModal()" style="flex: 1; padding: 10px;">Cancel</button>
                    <button type="button" id="programConfirmBtn" class="btn btn-primary" onclick="executeProgramRoboclaw()" style="flex: 1; padding: 10px; background: var(--button-primary-bg);">Program</button>
                </div>
            </div>
        </div>

        <!-- Change Hostname Modal -->
        <div id="hostnameModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Change Hostname</h3>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">New Hostname:</label>
                    <input type="text" id="hostnameInput" class="form-input" placeholder="e.g., crawler-01"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;"
                           maxlength="63" pattern="[a-z0-9][a-z0-9-]*[a-z0-9]">
                    <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 4px;">Lowercase letters, digits, hyphens. Must start and end with a letter or digit.</div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Master Password:</label>
                    <input type="password" id="hostnamePassword" class="form-input" placeholder="Enter master password"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div id="hostnameError" style="display: none; font-size: 11px; color: var(--status-error); margin-bottom: 12px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;"></div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeHostnameModal()" style="flex: 1; padding: 10px;">Cancel</button>
                    <button type="button" id="hostnameConfirmBtn" class="btn btn-primary" onclick="executeHostnameChange()" style="flex: 1; padding: 10px;">Save</button>
                </div>
            </div>
        </div>
        <!-- Network Status -->
        <div class="section">
            <div class="section-title">Network Status</div>
            <div class="network-info">
                <div class="network-item" style="cursor: pointer;" title="Click to change hostname">
                    <span class="label">Hostname</span>
                    <span class="value" id="hostnameDisplay" onclick="showHostnameModal()">--</span>
                    <svg onclick="copyHostname(event)" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="margin-left: 6px; flex-shrink: 0; cursor: pointer;" title="Copy hostname">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    <svg onclick="showHostnameModal()" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="margin-left: 4px; flex-shrink: 0; cursor: pointer;" title="Edit hostname"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </div>
                <div class="network-item">
                    <span class="label">WiFi</span>
                    <span class="value" id="wifiDisplay">--</span>
                </div>
                <div class="network-item">
                    <span class="label">Ethernet</span>
                    <span class="value" id="ethernetDisplay">--</span>
                </div>
            </div>
        </div>

        <!-- Cloud Dashboard (MQTT) -->
        <div class="section" id="mqttSection">
            <div class="section-title">Cloud Dashboard (MQTT)</div>
            <div class="network-info">
                <div class="network-item">
                    <span class="label">Status</span>
                    <span class="value" id="mqttStatusDisplay">--</span>
                </div>
                <div class="network-item">
                    <span class="label">Broker</span>
                    <span class="value" id="mqttBrokerDisplay">--</span>
                </div>
                <div class="network-item">
                    <span class="label">Service</span>
                    <span class="value" id="mqttServiceDisplay">--</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 12px; display: flex; justify-content: center; gap: 8px;">
                <button type="button" class="btn btn-secondary" onclick="showMqttAuth()" style="width: auto; padding: 10px 20px;">
                    Configure MQTT
                </button>
                <button type="button" class="btn btn-secondary" onclick="showMqttTopicsModal()" style="width: auto; padding: 10px 12px;" title="MQTT Topic Settings">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
            </div>
        </div>

        <!-- MQTT Auth Modal -->
        <div id="mqttAuthModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 360px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Configure MQTT</h3>
                    <button onclick="closeMqttModal()" style="background: none; border: none; cursor: pointer; padding: 4px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Master Password:</label>
                    <input type="password" id="mqttAuthPassword" class="form-input" placeholder="Enter master password"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 13px; color: var(--text-primary); font-weight: 500;">Enable MQTT</span>
                    <div id="mqttToggle" onclick="toggleMqttEnabled()" style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer;">
                        <input type="checkbox" id="mqttEnabled" style="display: none;">
                        <span id="mqttToggleTrack" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 24px; transition: 0.3s;">
                            <span id="mqttToggleThumb" style="position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                        </span>
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Broker URL:</label>
                    <input type="text" id="mqttBroker" class="form-input" placeholder="edge-primeinspections.com"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Port:</label>
                    <input type="number" id="mqttPort" class="form-input" placeholder="443" value="443"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">API Key:</label>
                    <div style="position: relative;">
                        <input type="password" id="mqttApiKey" class="form-input" placeholder="Enter API key"
                               style="width: 100%; padding: 10px 36px 10px 12px; font-size: 14px; box-sizing: border-box;">
                        <button type="button" onclick="toggleMqttApiKeyVisibility()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-tertiary);">
                            <svg id="mqttApiKeyEyeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                    </div>
                </div>

                <div id="mqttTestResult" style="display: none; font-size: 11px; margin-bottom: 12px; padding: 8px; border-radius: 6px;"></div>

                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="testMqttConnection()" id="mqttTestBtn" style="flex: 1; padding: 10px; font-size: 12px;">Test Connection</button>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeMqttModal()" style="flex: 1; padding: 10px;">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMqttConfig()" id="mqttSaveBtn" style="flex: 1; padding: 10px;">Save</button>
                </div>
            </div>
        </div>

        <!-- MQTT Topic Settings Modal -->
        <div id="mqttTopicsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--bg-primary); border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
              <div style="padding: 24px; overflow-y: auto; flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">MQTT Topic Settings</h3>
                    <button onclick="closeMqttTopicsModal()" style="background: none; border: none; cursor: pointer; padding: 4px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                </div>

                <div id="mqttTopicsList" style="margin-bottom: 16px;">
                    <!-- heartbeat topic -->
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Heartbeat</span>
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">hostname, crawler_name, uptime</div>
                            </div>
                            <div onclick="toggleTopicEnabled('heartbeat')" style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; flex-shrink: 0;">
                                <input type="checkbox" id="topicEnabled_heartbeat" style="display: none;" checked>
                                <span id="topicTrack_heartbeat" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--button-success-bg); border-radius: 24px; transition: 0.3s;">
                                    <span id="topicThumb_heartbeat" style="position: absolute; height: 18px; width: 18px; left: 23px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 12px; color: var(--text-tertiary); white-space: nowrap;">Interval:</label>
                            <input type="number" id="topicInterval_heartbeat" class="form-input" value="5.0" min="0.5" max="300" step="0.5"
                                   style="width: 80px; padding: 6px 8px; font-size: 13px; box-sizing: border-box;">
                            <span style="font-size: 12px; color: var(--text-tertiary);">seconds</span>
                        </div>
                        <!-- SIM ICCID -->
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">SIM ICCID</span>
                                <div onclick="toggleIccid()" style="position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                    <input type="checkbox" id="iccid_enabled" style="display: none;">
                                    <span id="iccidTrack" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 20px; transition: 0.3s;">
                                        <span id="iccidThumb" style="position: absolute; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                    </span>
                                </div>
                            </div>
                            <input type="text" id="iccid_value" class="form-input" placeholder="Enter SIM ICCID"
                                   style="width: 100%; padding: 6px 8px; font-size: 13px; box-sizing: border-box; font-family: monospace;">
                        </div>
                    </div>

                    <!-- system topic -->
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">System</span>
                            </div>
                            <div onclick="toggleTopicEnabled('system')" style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; flex-shrink: 0;">
                                <input type="checkbox" id="topicEnabled_system" style="display: none;" checked>
                                <span id="topicTrack_system" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--button-success-bg); border-radius: 24px; transition: 0.3s;">
                                    <span id="topicThumb_system" style="position: absolute; height: 18px; width: 18px; left: 23px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <label style="font-size: 12px; color: var(--text-tertiary); white-space: nowrap;">Interval:</label>
                            <input type="number" id="topicInterval_system" class="form-input" value="5.0" min="0.5" max="300" step="0.5"
                                   style="width: 80px; padding: 6px 8px; font-size: 13px; box-sizing: border-box;">
                            <span style="font-size: 12px; color: var(--text-tertiary);">seconds</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;" id="fields_system"></div>
                    </div>

                    <!-- imu topic -->
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">IMU</span>
                            </div>
                            <div onclick="toggleTopicEnabled('imu')" style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; flex-shrink: 0;">
                                <input type="checkbox" id="topicEnabled_imu" style="display: none;" checked>
                                <span id="topicTrack_imu" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--button-success-bg); border-radius: 24px; transition: 0.3s;">
                                    <span id="topicThumb_imu" style="position: absolute; height: 18px; width: 18px; left: 23px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <label style="font-size: 12px; color: var(--text-tertiary); white-space: nowrap;">Interval:</label>
                            <input type="number" id="topicInterval_imu" class="form-input" value="2.0" min="0.5" max="300" step="0.5"
                                   style="width: 80px; padding: 6px 8px; font-size: 13px; box-sizing: border-box;">
                            <span style="font-size: 12px; color: var(--text-tertiary);">seconds</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;" id="fields_imu"></div>
                    </div>

                    <!-- motor topic -->
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Motor</span>
                            </div>
                            <div onclick="toggleTopicEnabled('motor')" style="position: relative; display: inline-block; width: 44px; height: 24px; cursor: pointer; flex-shrink: 0;">
                                <input type="checkbox" id="topicEnabled_motor" style="display: none;" checked>
                                <span id="topicTrack_motor" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--button-success-bg); border-radius: 24px; transition: 0.3s;">
                                    <span id="topicThumb_motor" style="position: absolute; height: 18px; width: 18px; left: 23px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <label style="font-size: 12px; color: var(--text-tertiary); white-space: nowrap;">Interval:</label>
                            <input type="number" id="topicInterval_motor" class="form-input" value="2.0" min="0.5" max="300" step="0.5"
                                   style="width: 80px; padding: 6px 8px; font-size: 13px; box-sizing: border-box;">
                            <span style="font-size: 12px; color: var(--text-tertiary);">seconds</span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;" id="fields_motor"></div>
                    </div>

                    <!-- settings response -->
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 8px; border: 1px solid var(--border-color);">
                        <div style="margin-bottom: 8px;">
                            <span style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Settings</span>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">Sent when requested by server</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px;" id="fields_settings"></div>
                    </div>
                </div>

                <div id="mqttTopicsError" style="display: none; font-size: 11px; color: var(--status-error); margin-bottom: 12px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;"></div>

                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeMqttTopicsModal()" style="flex: 1; padding: 10px;">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMqttTopics()" id="mqttTopicsSaveBtn" style="flex: 1; padding: 10px;">Save</button>
                </div>
              </div>
            </div>
        </div>

        <!-- MQTT Topics Password Prompt -->
        <div id="mqttTopicsPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: var(--bg-primary); border-radius: 16px; padding: 24px; max-width: 320px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.2);">
                <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">MQTT Topic Settings</h3>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Master Password:</label>
                    <input type="password" id="mqttTopicsPwPrompt" class="form-input" placeholder="Enter master password"
                           style="width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;">
                </div>
                <div id="mqttTopicsPwError" style="display: none; font-size: 11px; color: var(--status-error); margin-bottom: 12px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="closeMqttTopicsPwPrompt()" style="flex: 1; padding: 10px;">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="verifyMqttTopicsPassword()" id="mqttTopicsPwBtn" style="flex: 1; padding: 10px;">Unlock</button>
                </div>
            </div>
        </div>

        <!-- Crawler Selection (Hidden - accessed via Config Tools) -->
        <div class="section" id="crawlerTypeSection" style="display: none;">
            <div class="section-title">Crawler Type</div>
            <div class="crawler-options" id="crawlerOptions">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <!-- Hotspot Settings Section -->
        <div class="section" style="margin-top: 20px; text-align: center;">
            <div class="section-title">WiFi Hotspot</div>
            <div class="hotspot-info" style="display: inline-block;">
                <span class="label">Current SSID:</span>
                <span class="value" id="currentSsidDisplay">--</span>
            </div>
            <div>
                <button type="button" class="btn btn-secondary" onclick="showHotspotAuth()" style="margin-top: 12px;">
                    Change Hotspot Settings
                </button>
            </div>
        </div>

        <!-- Reboot Section -->
        <div class="section" style="margin-top: 20px; text-align: center;">
            <div class="section-title">System Control</div>
            <div class="reboot-notice" style="text-align: center;">
                Changes will be saved and applied after reboot.
            </div>
            <button type="button" class="btn btn-danger" onclick="saveAndReboot()">Reboot and Save Changes</button>
        </div>

        <!-- Config Tools Button -->
        <div class="section" style="margin-top: 20px; text-align: center;">
            <button type="button" class="btn btn-secondary" onclick="openConfigTools()" style="width: auto; padding: 10px 20px;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                Open Config Tools
            </button>
        </div>
    </div>

    <!-- Config Tools Modal -->
    <div id="configToolsModal" class="modal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Config Tools</span>
                <button onclick="closeConfigTools()" style="background: none; border: none; cursor: pointer; padding: 4px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#86868b" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <!-- Crawler Type Selection -->
            <div style="margin-bottom: 20px;">
                <div class="section-title" style="margin-bottom: 10px;">Crawler Type</div>
                <select id="crawlerSelect" class="form-input" style="cursor: pointer;" onchange="onCrawlerSelectChange()">
                    <option value="">Loading...</option>
                </select>
                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 6px;">
                    Current: <span id="currentCrawlerName" style="font-weight: 500;">--</span>
                </div>
            </div>

            <!-- Page Preview (Debug) -->
            <div style="margin-bottom: 20px;">
                <div class="section-title" style="margin-bottom: 10px;">Page Preview (Debug)</div>
                <div style="background: #f9f9f9; border-radius: 10px; padding: 12px; max-height: 300px; overflow-y: auto;">
                    <p style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 10px;">Test pages in debug mode:</p>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <a href="/boot_splash.html?debug=true" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Boot Splash Screen
                        </a>
                        <a href="/device_mismatch.html?debug=true" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            Device Mismatch Page
                        </a>
                        <a href="/config.html" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            Config Page
                        </a>
                        <a href="/index.html" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                            Index (Home)
                        </a>
                        <a href="/magnetic_phased_array.html" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            Magnetic Phased Array
                        </a>
                        <a href="/edgeflex.html" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            EdgeFlex RoboClaw
                        </a>
                        <a href="/edgeflex_clearlink.html" style="display: flex; align-items: center; gap: 8px; color: var(--status-info); font-size: 12px; text-decoration: none; padding: 8px 10px; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-color);">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            EdgeFlex ClearLink
                        </a>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeConfigTools()">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveConfigTools()" id="saveConfigToolsBtn" disabled>Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Hotspot Auth Modal -->
    <div id="hotspotAuthModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Authentication Required</div>
            <div class="form-group">
                <label class="form-label">Enter admin password to change hotspot settings</label>
                <input type="password" id="hotspotAuthPassword" class="form-input" placeholder="Password">
            </div>
            <div id="authDenied" class="access-denied">Access denied. Incorrect password.</div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeHotspotAuth()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="checkHotspotAuth()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Hotspot Settings Modal -->
    <div id="hotspotSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Hotspot Settings</div>
            <div class="form-group">
                <label class="form-label">Network Name (SSID)</label>
                <input type="text" id="hotspotSsid" class="form-input" maxlength="32">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="text" id="hotspotPassword" class="form-input" maxlength="63">
                <div class="form-hint">Minimum 8 characters</div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeHotspotSettings()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveHotspotSettings()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Master password cache (5 minute TTL)
        var _cachedMasterPw = '';
        var _cachedMasterPwExpiry = 0;
        var MASTER_PW_TTL = 5 * 60 * 1000; // 5 minutes in ms

        function cacheMasterPassword(pw) {
            _cachedMasterPw = pw;
            _cachedMasterPwExpiry = Date.now() + MASTER_PW_TTL;
        }

        function getCachedMasterPassword() {
            if (_cachedMasterPw && Date.now() < _cachedMasterPwExpiry) {
                return _cachedMasterPw;
            }
            _cachedMasterPw = '';
            return '';
        }

        function clearMasterPasswordCache() {
            _cachedMasterPw = '';
            _cachedMasterPwExpiry = 0;
        }

        var currentConfig = {};
        var selectedCrawler = null;
        var selectedSsid = '';
        var pendingHotspotSsid = null;
        var pendingHotspotPassword = null;

        var CRAWLERS = {
            'magnetic': { name: 'Magnetic Pipe Crawler', hostname: 'magnetic' },
            'xpressscan_singlewall': { name: 'Express Scan - Single Wall', hostname: 'xpressscan-sw' },
            'xpressscan_doublewall': { name: 'Express Scan - Double Wall', hostname: 'xpressscan-dw' },
            'edgeflex': { name: 'EdgeFlex RoboClaw', hostname: 'edgeflex' },
            'edgeflex_clearlink': { name: 'EdgeFlex ClearLink', hostname: 'edgeflex' }
        };

        function loadConfig() {
            fetch('/api/config')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    currentConfig = data;
                    selectedCrawler = data.crawler_id;
                    pendingHotspotSsid = data.ssid;
                    pendingHotspotPassword = data.password;

                    // Update displays
                    document.getElementById('currentSsidDisplay').textContent = data.ssid || '--';
                    document.getElementById('hotspotSsid').value = data.ssid || '';
                    document.getElementById('hotspotPassword').value = data.password || '';

                    // Network info (Safari-compatible - no optional chaining)
                    var hostname = (data.network && data.network.hostname) ? data.network.hostname : '--';
                    document.getElementById('hostnameDisplay').textContent = hostname;
                    var wifi = (data.network && data.network.wifi) ? data.network.wifi : null;
                    if (wifi && wifi.ip) {
                        document.getElementById('wifiDisplay').textContent = wifi.ip + (wifi.ssid ? ' (' + wifi.ssid + ')' : '');
                    } else {
                        document.getElementById('wifiDisplay').textContent = 'Not connected';
                        document.getElementById('wifiDisplay').classList.add('none');
                    }
                    var eth = (data.network && data.network.ethernet) ? data.network.ethernet : null;
                    if (eth && eth.ip) {
                        document.getElementById('ethernetDisplay').textContent = eth.ip;
                    } else {
                        document.getElementById('ethernetDisplay').textContent = 'Not connected';
                        document.getElementById('ethernetDisplay').classList.add('none');
                    }

                    // Render crawler options
                    renderCrawlerOptions();
                })
                .catch(function(err) {
                    showError('Failed to load configuration');
                    console.error(err);
                });
        }

        function renderCrawlerOptions() {
            var container = document.getElementById('crawlerOptions');
            container.innerHTML = '';

            for (var id in CRAWLERS) {
                var crawler = CRAWLERS[id];
                var isCurrent = id === currentConfig.crawler_id;
                var isSelected = id === selectedCrawler;

                var div = document.createElement('label');
                div.className = 'crawler-option' + (isCurrent ? ' current' : '') + (isSelected ? ' selected' : '');
                div.onclick = (function(crawlerId, element) {
                    return function() { selectCrawler(crawlerId, element); };
                })(id, div);

                div.innerHTML = '<input type="radio" name="crawler_id" value="' + id + '"' + (isSelected ? ' checked' : '') + '>' +
                    '<span class="crawler-name">' + crawler.name + '</span>';

                container.appendChild(div);
            }
        }

        function selectCrawler(id, element) {
            document.querySelectorAll('.crawler-option').forEach(function(el) { el.classList.remove('selected'); });
            element.classList.add('selected');
            element.querySelector('input[type="radio"]').checked = true;
            selectedCrawler = id;
        }

        function saveAndReboot() {
            if (!selectedCrawler) {
                showError('Please select a crawler type');
                return;
            }

            if (!confirm('Save changes and reboot the crawler now?')) {
                return;
            }

            // First save the configuration
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    crawler_id: selectedCrawler,
                    ssid: pendingHotspotSsid,
                    password: pendingHotspotPassword
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    // Now reboot
                    fetch('/api/reboot', { method: 'POST' })
                        .then(function(r) { return r.json(); })
                        .then(function(rebootData) {
                            if (rebootData.success) {
                                document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;"><div style="text-align:center;"><h2>Rebooting...</h2><p>Configuration saved. The crawler is restarting.</p><p>Please wait and reconnect.</p></div></div>';
                            } else {
                                showError('Configuration saved but reboot failed: ' + (rebootData.error || 'Unknown error'));
                            }
                        })
                        .catch(function(err) {
                            showError('Configuration saved but reboot failed');
                        });
                } else {
                    showError(data.error || 'Failed to save configuration');
                }
            })
            .catch(function(err) {
                showError('Failed to save configuration');
                console.error(err);
            });
        }

        // WiFi functions moved to main control page

        function showHotspotAuth() {
            document.getElementById('hotspotAuthPassword').value = '';
            document.getElementById('authDenied').style.display = 'none';
            document.getElementById('hotspotAuthModal').classList.add('show');
            document.getElementById('hotspotAuthPassword').focus();
        }

        function closeHotspotAuth() {
            document.getElementById('hotspotAuthModal').classList.remove('show');
        }

        function checkHotspotAuth() {
            var password = document.getElementById('hotspotAuthPassword').value;
            if (password === 'Prime') {
                closeHotspotAuth();
                showHotspotSettings();
            } else {
                document.getElementById('authDenied').style.display = 'block';
                document.getElementById('hotspotAuthPassword').value = '';
                document.getElementById('hotspotAuthPassword').focus();
            }
        }

        function showHotspotSettings() {
            document.getElementById('hotspotSsid').value = pendingHotspotSsid || '';
            document.getElementById('hotspotPassword').value = pendingHotspotPassword || '';
            document.getElementById('hotspotSettingsModal').classList.add('show');
            document.getElementById('hotspotSsid').focus();
        }

        function closeHotspotSettings() {
            document.getElementById('hotspotSettingsModal').classList.remove('show');
        }

        function saveHotspotSettings() {
            var ssid = document.getElementById('hotspotSsid').value.trim();
            var password = document.getElementById('hotspotPassword').value.trim();

            if (ssid.length < 1 || ssid.length > 32) {
                alert('SSID must be 1-32 characters');
                return;
            }
            if (password.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            pendingHotspotSsid = ssid;
            pendingHotspotPassword = password;
            document.getElementById('currentSsidDisplay').textContent = ssid;

            closeHotspotSettings();
            showSuccess('Hotspot settings updated. Click "Reboot and Save Changes" to apply.');
        }

        function showError(msg) {
            var el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
            document.getElementById('successMsg').classList.remove('show');
            setTimeout(function() { el.classList.remove('show'); }, 5000);
        }

        function showSuccess(msg) {
            var el = document.getElementById('successMsg');
            el.textContent = msg;
            el.classList.add('show');
            document.getElementById('errorMsg').classList.remove('show');
            setTimeout(function() { el.classList.remove('show'); }, 5000);
        }

        // Allow Enter key in modals
        document.getElementById('hotspotAuthPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkHotspotAuth();
        });

        // =====================================================================
        // Config Tools Modal Functions
        // =====================================================================

        var configToolsSelectedCrawler = null;

        function openConfigTools() {
            var modal = document.getElementById('configToolsModal');
            var select = document.getElementById('crawlerSelect');
            var currentName = document.getElementById('currentCrawlerName');
            var saveBtn = document.getElementById('saveConfigToolsBtn');

            // Populate the dropdown
            select.innerHTML = '';
            for (var id in CRAWLERS) {
                var opt = document.createElement('option');
                opt.value = id;
                opt.textContent = CRAWLERS[id].name;
                if (id === currentConfig.crawler_id) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            }

            // Show current crawler name (Safari-compatible - no optional chaining)
            var crawlerEntry = CRAWLERS[currentConfig.crawler_id];
            currentName.textContent = (crawlerEntry && crawlerEntry.name) ? crawlerEntry.name : (currentConfig.crawler_id || '--');

            // Reset state
            configToolsSelectedCrawler = currentConfig.crawler_id;
            saveBtn.disabled = true;

            modal.classList.add('show');
        }

        function closeConfigTools() {
            document.getElementById('configToolsModal').classList.remove('show');
        }

        function onCrawlerSelectChange() {
            var select = document.getElementById('crawlerSelect');
            var saveBtn = document.getElementById('saveConfigToolsBtn');

            configToolsSelectedCrawler = select.value;

            // Enable save button only if different from current
            saveBtn.disabled = (configToolsSelectedCrawler === currentConfig.crawler_id);
        }

        function saveConfigTools() {
            if (!configToolsSelectedCrawler || configToolsSelectedCrawler === currentConfig.crawler_id) {
                closeConfigTools();
                return;
            }

            // Update the selected crawler in the main form
            selectedCrawler = configToolsSelectedCrawler;

            // Update the hidden crawler options (for saveAndReboot)
            renderCrawlerOptions();

            closeConfigTools();
            showSuccess('Crawler type changed to ' + CRAWLERS[selectedCrawler].name + '. Click "Reboot and Save Changes" to apply.');
        }

        // Close Config Tools modal when clicking outside
        document.getElementById('configToolsModal').addEventListener('click', function(e) {
            if (e.target === this) closeConfigTools();
        });

        // =====================================================================
        // Device Security Lock Functions (v2 - Multi-Device)
        // =====================================================================

        var securityData = null;

        function loadSecurityStatus() {
            fetch('/api/security/status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    securityData = data;

                    // Check if security module is not installed
                    if (data.error && data.error.indexOf('not installed') !== -1) {
                        document.getElementById('securitySection').style.display = 'none';
                        return;
                    }

                    var noMasterPw = document.getElementById('noMasterPassword');

                    // Check if master password is set
                    if (!data.master_password_set) {
                        noMasterPw.style.display = 'block';
                        document.getElementById('deviceBindingsBody').innerHTML =
                            '<tr><td colspan="5" style="padding: 15px; text-align: center; color: var(--text-tertiary);">Master password not configured</td></tr>';
                        document.getElementById('deviceBindingsNote').style.display = 'none';
                        return;
                    }

                    noMasterPw.style.display = 'none';

                    // Update device bindings table with action buttons
                    updateDeviceBindingsTable(data);
                })
                .catch(function(err) {
                    console.error('Error loading security status:', err);
                    document.getElementById('securitySection').style.display = 'none';
                });
        }

        function updateDeviceBindingsTable(data) {
            var tbody = document.getElementById('deviceBindingsBody');
            var html = '';
            // Always show all three devices
            var allDevices = ['cm5', 'roboclaw', 'clearlink'];
            var anyNotDetected = false;
            var anyNotProgrammed = false;

            var deviceNames = {
                'cm5': 'CM5 CPU',
                'roboclaw': 'RoboClaw',
                'clearlink': 'ClearLink'
            };

            allDevices.forEach(function(device) {
                var info = data[device] || {};
                var locked = info.locked || false;
                var detected = info.detected !== false;
                var match = info.match !== false;

                var connectedVal = '';
                var lockedVal = '';
                var statusHtml = '';
                var actionHtml = '';
                var isRoboclawNotProgrammed = false;

                if (device === 'cm5') {
                    connectedVal = info.current_serial ? info.current_serial.slice(-8) : 'Not detected';
                    lockedVal = locked ? info.locked_serial.slice(-8) : 'Not locked';
                } else if (device === 'roboclaw') {
                    // RoboClaw has special states: not detected, detected but not programmed, detected with EEPROM ID
                    if (!info.current_serial) {
                        connectedVal = 'Not detected';
                    } else if (/^[0-9A-F]{12}$/.test(info.current_serial)) {
                        // Has programmed ID (12-char hex)
                        connectedVal = info.current_serial;
                    } else {
                        // Detected but no EEPROM ID (returns firmware version)
                        connectedVal = 'Not programmed';
                        isRoboclawNotProgrammed = true;
                        anyNotProgrammed = true;
                    }
                    lockedVal = locked ? (info.locked_serial.length > 20 ? info.locked_serial.slice(0, 20) + '...' : info.locked_serial) : 'Not locked';
                } else if (device === 'clearlink') {
                    connectedVal = info.current_mac || 'Not detected';
                    lockedVal = locked ? info.locked_mac : 'Not locked';
                }

                if (!detected) anyNotDetected = true;

                if (locked) {
                    if (!detected) {
                        statusHtml = '<span style="color: #ff9500;">&#8212; Not detected</span>';
                    } else if (match) {
                        statusHtml = '<span style="color: var(--status-ok);">&#128274; Locked</span>';
                    } else {
                        statusHtml = '<span style="color: var(--status-error);">&#10007; MISMATCH</span>';
                    }
                    // Locked: show Unlock button (always enabled - need to unlock even if not detected)
                    actionHtml = '<button type="button" class="btn btn-secondary" onclick="openDeviceModal(\'' + device + '\', \'unlock\')" style="padding: 4px 12px; font-size: 11px;">Unlock</button>';
                } else {
                    statusHtml = '<span style="color: var(--text-tertiary);">&#128275; Unlocked</span>';

                    // Special case: RoboClaw detected but not programmed - show Program ID button
                    if (device === 'roboclaw' && isRoboclawNotProgrammed) {
                        actionHtml = '<button type="button" class="btn btn-primary" onclick="openProgramModal()" style="padding: 4px 12px; font-size: 11px; background: var(--button-primary-bg);">Program ID</button>';
                    } else if (detected) {
                        // Normal case: show Lock button
                        actionHtml = '<button type="button" class="btn btn-primary" onclick="openDeviceModal(\'' + device + '\', \'lock\')" style="padding: 4px 12px; font-size: 11px; background: var(--status-warning);">Lock</button>';
                    } else {
                        // Not detected: show disabled Lock button
                        actionHtml = '<button type="button" class="btn btn-secondary" disabled style="padding: 4px 12px; font-size: 11px; opacity: 0.5; cursor: not-allowed;">Lock</button>';
                    }
                }

                html += '<tr>';
                html += '<td style="font-weight: 500;">' + deviceNames[device] + '</td>';
                html += '<td style="font-family: monospace; font-size: 11px; color: ' + (detected && !isRoboclawNotProgrammed ? 'var(--text-primary)' : 'var(--text-tertiary)') + ';">' + connectedVal + '</td>';
                html += '<td style="font-family: monospace; font-size: 11px; color: ' + (locked ? 'var(--text-primary)' : 'var(--text-tertiary)') + ';">' + lockedVal + '</td>';
                html += '<td>' + statusHtml + '</td>';
                html += '<td>' + actionHtml + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;

            // Show/hide the note about devices needing to be connected
            var noteText = '';
            if (anyNotDetected) noteText = 'Note: Devices must be connected before they can be locked.';
            if (anyNotProgrammed) noteText += (noteText ? ' ' : '') + 'RoboClaw requires programming an ID before it can be locked.';
            var noteEl = document.getElementById('deviceBindingsNote');
            noteEl.textContent = noteText;
            noteEl.style.display = noteText ? 'block' : 'none';
        }

        var deviceNames = {
            'cm5': 'CM5 CPU',
            'roboclaw': 'RoboClaw',
            'clearlink': 'ClearLink'
        };

        function openDeviceModal(device, action) {
            var modal = document.getElementById('deviceActionModal');
            var title = document.getElementById('modalTitle');
            var lockSection = document.getElementById('lockConfirmSection');
            var noteEl = document.getElementById('modalNote');
            var confirmBtn = document.getElementById('modalConfirmBtn');

            document.getElementById('modalDevice').value = device;
            document.getElementById('modalAction').value = action;
            document.getElementById('modalPassword').value = getCachedMasterPassword();
            document.getElementById('modalLockConfirm').value = '';

            if (action === 'lock') {
                title.textContent = 'Lock ' + deviceNames[device];
                lockSection.style.display = 'block';
                confirmBtn.style.background = '#ff9500';
                confirmBtn.textContent = 'Lock';
                if (device === 'cm5') {
                    noteEl.innerHTML = 'This will encrypt the source code and bind it to this device.';
                } else {
                    noteEl.innerHTML = 'This will bind the software to this specific ' + deviceNames[device] + '.';
                }
            } else {
                title.textContent = 'Unlock ' + deviceNames[device];
                lockSection.style.display = 'none';
                confirmBtn.style.background = '#007aff';
                confirmBtn.textContent = 'Unlock';
                if (device === 'cm5') {
                    noteEl.innerHTML = 'This will decrypt the source code so it can be cloned to other devices.';
                } else {
                    noteEl.innerHTML = 'This will remove the hardware binding for ' + deviceNames[device] + '.';
                }
            }

            modal.style.display = 'flex';
            document.getElementById('modalPassword').focus();
        }

        function closeDeviceModal() {
            document.getElementById('deviceActionModal').style.display = 'none';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalLockConfirm').value = '';
        }

        function executeDeviceAction() {
            var device = document.getElementById('modalDevice').value;
            var action = document.getElementById('modalAction').value;
            var password = document.getElementById('modalPassword').value;
            var lockConfirm = document.getElementById('modalLockConfirm').value.toUpperCase();

            if (!password) {
                showError('Enter the master password');
                return;
            }

            if (action === 'lock' && lockConfirm !== 'LOCK') {
                showError('Type "LOCK" to confirm device locking');
                return;
            }

            var confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = action === 'lock' ? 'Locking...' : 'Unlocking...';

            if (action === 'lock') {
                fetch('/api/security/lock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: device, confirmation: 'LOCK', master_password: password })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        cacheMasterPassword(password);
                        closeDeviceModal();
                        if (device === 'cm5') {
                            document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;background:#f5f5f7;"><div style="text-align:center;background:white;padding:40px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);"><h2 style="color:#1d1d1f;margin-bottom:12px;">Locking Device...</h2><p style="color:#86868b;">' + data.message + '</p></div></div>';
                        } else {
                            showSuccess(data.message);
                            loadSecurityStatus();
                        }
                    } else {
                        showError(data.error || 'Lock failed');
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Lock';
                    }
                })
                .catch(function(err) {
                    showError('Lock request failed');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Lock';
                });
            } else {
                fetch('/api/security/unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: device, master_password: password })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        cacheMasterPassword(password);
                        closeDeviceModal();
                        if (device === 'cm5') {
                            document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;background:#f5f5f7;"><div style="text-align:center;background:white;padding:40px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08);"><h2 style="color:#1d1d1f;margin-bottom:12px;">Unlocking Device...</h2><p style="color:#86868b;">' + data.message + '</p></div></div>';
                        } else {
                            showSuccess(data.message);
                            loadSecurityStatus();
                        }
                    } else {
                        showError(data.error || 'Unlock failed');
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Unlock';
                    }
                })
                .catch(function(err) {
                    showError('Unlock request failed');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Unlock';
                });
            }
        }

        // Program RoboClaw ID Modal Functions
        function openProgramModal() {
            document.getElementById('programIdInput').value = '';
            document.getElementById('programRoboclawModal').style.display = 'flex';
            document.getElementById('programIdInput').focus();
        }

        function closeProgramModal() {
            document.getElementById('programRoboclawModal').style.display = 'none';
            document.getElementById('programIdInput').value = '';
        }

        function executeProgramRoboclaw() {
            var customId = document.getElementById('programIdInput').value.trim().toUpperCase();
            var confirmBtn = document.getElementById('programConfirmBtn');

            // Validate custom ID if provided
            if (customId) {
                // Must be valid hex characters only, 6-12 chars
                if (!/^[0-9A-F]{6,12}$/.test(customId)) {
                    showError('ID must be 6-12 hex characters (0-9, A-F)');
                    return;
                }
                // Pad to 12 characters if less
                while (customId.length < 12) {
                    customId = '0' + customId;
                }
            }

            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Programming...';

            fetch('/api/security/program_roboclaw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ custom_id: customId })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    closeProgramModal();
                    showSuccess('RoboClaw programmed: ' + data.new_id);
                    loadSecurityStatus();
                } else {
                    showError(data.error || 'Programming failed');
                }
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Program';
            })
            .catch(function(err) {
                showError('Programming request failed');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Program';
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeviceModal();
                closeProgramModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('deviceActionModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeviceModal();
        });

        // Handle Enter key in modal inputs
        document.getElementById('modalPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                var action = document.getElementById('modalAction').value;
                if (action === 'unlock') {
                    executeDeviceAction();
                } else {
                    document.getElementById('modalLockConfirm').focus();
                }
            }
        });

        document.getElementById('modalLockConfirm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') executeDeviceAction();
        });

        // Close Program modal when clicking outside
        document.getElementById('programRoboclawModal').addEventListener('click', function(e) {
            if (e.target === this) closeProgramModal();
        });

        // Handle Enter key in Program modal
        document.getElementById('programIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') executeProgramRoboclaw();
        });


        function showHostnameModal() {
            var current = document.getElementById("hostnameDisplay").textContent;
            document.getElementById("hostnameInput").value = (current !== "--") ? current : "";
            document.getElementById("hostnamePassword").value = getCachedMasterPassword();
            document.getElementById("hostnameError").style.display = "none";
            document.getElementById("hostnameModal").style.display = "flex";
        }

        function closeHostnameModal() {
            document.getElementById("hostnameModal").style.display = "none";
        }

        function executeHostnameChange() {
            var hostname = document.getElementById("hostnameInput").value.trim().toLowerCase();
            var password = document.getElementById("hostnamePassword").value;
            var errorEl = document.getElementById("hostnameError");
            var btn = document.getElementById("hostnameConfirmBtn");

            if (!hostname) {
                errorEl.textContent = "Hostname cannot be empty.";
                errorEl.style.display = "block";
                return;
            }
            if (!password) {
                errorEl.textContent = "Master password is required.";
                errorEl.style.display = "block";
                return;
            }

            btn.disabled = true;
            btn.textContent = "Saving...";
            errorEl.style.display = "none";

            fetch("/api/config/hostname", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ hostname: hostname, master_password: password })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                btn.textContent = "Save";
                if (data.success) {
                    cacheMasterPassword(password);
                    document.getElementById("hostnameDisplay").textContent = data.hostname;
                    closeHostnameModal();
                } else {
                    errorEl.textContent = data.error || "Failed to change hostname.";
                    errorEl.style.display = "block";
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = "Save";
                errorEl.textContent = "Network error. Please try again.";
                errorEl.style.display = "block";
            });
        }

        document.getElementById("hostnameInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") executeHostnameChange();
        });
        document.getElementById("hostnamePassword").addEventListener("keypress", function(e) {
            if (e.key === "Enter") executeHostnameChange();
        });
        // =====================================================================
        // Hostname Copy Function
        // =====================================================================

        function copyHostname(e) {
            e.stopPropagation();
            var hostname = document.getElementById('hostnameDisplay').textContent;
            if (hostname && hostname !== '--') {
                var fullHostname = hostname + '.local';
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(fullHostname).then(function() {
                        showSuccess('Copied: ' + fullHostname);
                    });
                } else {
                    var ta = document.createElement('textarea');
                    ta.value = fullHostname;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showSuccess('Copied: ' + fullHostname);
                }
            }
        }

        // =====================================================================
        // MQTT Cloud Dashboard Functions
        // =====================================================================

        function loadMqttStatus() {
            fetch('/api/mqtt/status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var statusEl = document.getElementById('mqttStatusDisplay');
                    var brokerEl = document.getElementById('mqttBrokerDisplay');
                    var serviceEl = document.getElementById('mqttServiceDisplay');

                    if (data.enabled) {
                        statusEl.textContent = 'Enabled';
                        statusEl.style.color = 'var(--status-ok)';
                    } else {
                        statusEl.textContent = 'Disabled';
                        statusEl.style.color = 'var(--text-tertiary)';
                    }

                    brokerEl.textContent = data.broker || 'Not configured';
                    if (!data.broker) brokerEl.classList.add('none');

                    if (data.service_running) {
                        serviceEl.textContent = 'Running';
                        serviceEl.style.color = 'var(--status-ok)';
                    } else {
                        serviceEl.textContent = 'Stopped';
                        serviceEl.style.color = 'var(--text-tertiary)';
                    }
                })
                .catch(function() {
                    document.getElementById('mqttStatusDisplay').textContent = 'Error';
                });
        }

        function showMqttAuth() {
            document.getElementById('mqttAuthPassword').value = getCachedMasterPassword();
            document.getElementById('mqttTestResult').style.display = 'none';

            // Pre-fill current values
            fetch('/api/mqtt/status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    document.getElementById('mqttBroker').value = data.broker || '';
                    document.getElementById('mqttPort').value = data.port || 443;
                    document.getElementById('mqttEnabled').checked = data.enabled;
                    updateMqttToggleVisual();
                    // Don't pre-fill API key for security
                    document.getElementById('mqttApiKey').value = '';
                });

            document.getElementById('mqttAuthModal').style.display = 'flex';
            document.getElementById('mqttAuthPassword').focus();
        }

        function toggleMqttEnabled() {
            var cb = document.getElementById('mqttEnabled');
            cb.checked = !cb.checked;
            updateMqttToggleVisual();
        }

        function updateMqttToggleVisual() {
            var on = document.getElementById('mqttEnabled').checked;
            var track = document.getElementById('mqttToggleTrack');
            var thumb = document.getElementById('mqttToggleThumb');
            track.style.background = on ? 'var(--button-success-bg)' : '#ccc';
            thumb.style.left = on ? '23px' : '3px';
        }

        function closeMqttModal() {
            document.getElementById('mqttAuthModal').style.display = 'none';
        }

        function toggleMqttApiKeyVisibility() {
            var input = document.getElementById('mqttApiKey');
            input.type = (input.type === 'password') ? 'text' : 'password';
        }

        function testMqttConnection() {
            var password = document.getElementById('mqttAuthPassword').value;
            var broker = document.getElementById('mqttBroker').value.trim();
            var port = document.getElementById('mqttPort').value;
            var apiKey = document.getElementById('mqttApiKey').value.trim();
            var resultEl = document.getElementById('mqttTestResult');
            var btn = document.getElementById('mqttTestBtn');

            if (!password) {
                resultEl.textContent = 'Enter master password first.';
                resultEl.style.background = 'var(--status-error-bg)';
                resultEl.style.color = 'var(--status-error)';
                resultEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Testing...';
            resultEl.style.display = 'none';

            fetch('/api/mqtt/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    master_password: password,
                    broker: broker,
                    port: parseInt(port),
                    api_key: apiKey
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                btn.textContent = 'Test Connection';
                if (data.success) {
                    cacheMasterPassword(password);
                    resultEl.textContent = 'Connection successful!';
                    resultEl.style.background = '#e8f5e9';
                    resultEl.style.color = '#2e7d32';
                } else {
                    resultEl.textContent = data.error || 'Connection failed';
                    resultEl.style.background = 'var(--status-error-bg)';
                    resultEl.style.color = 'var(--status-error)';
                }
                resultEl.style.display = 'block';
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = 'Test Connection';
                resultEl.textContent = 'Request failed';
                resultEl.style.background = 'var(--status-error-bg)';
                resultEl.style.color = 'var(--status-error)';
                resultEl.style.display = 'block';
            });
        }

        function saveMqttConfig() {
            var password = document.getElementById('mqttAuthPassword').value;
            var broker = document.getElementById('mqttBroker').value.trim();
            var port = document.getElementById('mqttPort').value;
            var apiKey = document.getElementById('mqttApiKey').value.trim();
            var enabled = document.getElementById('mqttEnabled').checked;
            var btn = document.getElementById('mqttSaveBtn');

            if (!password) {
                showError('Master password is required');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Saving...';

            var body = {
                master_password: password,
                enabled: enabled,
                broker: broker,
                port: parseInt(port)
            };
            // Only send api_key if user entered one
            if (apiKey) {
                body.api_key = apiKey;
            }

            fetch('/api/mqtt/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                btn.textContent = 'Save';
                if (data.success) {
                    cacheMasterPassword(password);
                    closeMqttModal();
                    showSuccess('MQTT configuration saved.');
                    loadMqttStatus();
                } else {
                    showError(data.error || 'Failed to save MQTT config');
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = 'Save';
                showError('Failed to save MQTT config');
            });
        }

        // =====================================================================
        // MQTT Topic Settings Functions
        // =====================================================================

        var _mqttTopicsPassword = '';  // Stored after password verification

        // Topic groups and their fields
        var TOPIC_GROUPS = ['heartbeat', 'system', 'imu', 'motor'];
        var GROUP_FIELDS = {
            'system': ['cpu_temp', 'ram', 'storage', 'revision'],
            'imu': ['roll', 'pitch', 'cal_roll', 'cal_pitch'],
            'motor': ['connected', 'm1_speed', 'm2_speed', 'm1_torque', 'm2_torque']
        };
        var SETTINGS_FIELDS = ['pipeDiameter', 'jogSpeedInSec', 'rampPercent', 'distanceMode',
            'motorDriver', 'imuInvertAngle', 'motorParams'];
        var FIELD_LABELS = {
            'cpu_temp': 'CPU Temp', 'ram': 'RAM', 'storage': 'Storage', 'revision': 'Revision',
            'roll': 'Roll', 'pitch': 'Pitch', 'cal_roll': 'Calibrated Roll', 'cal_pitch': 'Calibrated Pitch',
            'connected': 'Connected', 'm1_speed': 'Motor 1 Speed (in/s)', 'm2_speed': 'Motor 2 Speed (in/s)',
            'm1_torque': 'Motor 1 Torque (Nm)', 'm2_torque': 'Motor 2 Torque (Nm)',
            'pipeDiameter': 'Pipe Diameter', 'jogSpeedInSec': 'Jog Speed', 'rampPercent': 'Ramp',
            'distanceMode': 'Distance Mode', 'motorDriver': 'Motor Driver',
            'imuInvertAngle': 'IMU Invert Angle', 'motorParams': 'Motor Parameters'
        };
        var GROUP_DEFAULTS = {
            'heartbeat': {interval: 5.0},
            'system': {interval: 5.0},
            'imu': {interval: 2.0},
            'motor': {interval: 2.0}
        };

        function buildFieldToggleHtml(fieldId) {
            var label = FIELD_LABELS[fieldId] || fieldId;
            return '<div style="display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background: var(--bg-primary); border-radius: 6px;">' +
                '<span style="font-size: 12px; color: var(--text-primary);">' + label + '</span>' +
                '<div onclick="toggleField(\'' + fieldId + '\')" style="position: relative; display: inline-block; width: 36px; height: 20px; cursor: pointer; flex-shrink: 0;">' +
                '<input type="checkbox" id="field_' + fieldId + '" style="display: none;" checked>' +
                '<span id="fieldTrack_' + fieldId + '" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--button-success-bg); border-radius: 20px; transition: 0.3s;">' +
                '<span id="fieldThumb_' + fieldId + '" style="position: absolute; height: 14px; width: 14px; left: 19px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>' +
                '</span></div></div>';
        }

        function renderFieldToggles() {
            for (var group in GROUP_FIELDS) {
                var container = document.getElementById('fields_' + group);
                if (!container) continue;
                var html = '';
                GROUP_FIELDS[group].forEach(function(f) { html += buildFieldToggleHtml(f); });
                container.innerHTML = html;
            }
            // Settings response fields
            var sc = document.getElementById('fields_settings');
            if (sc) {
                var html = '';
                SETTINGS_FIELDS.forEach(function(f) { html += buildFieldToggleHtml(f); });
                sc.innerHTML = html;
            }
        }

        function showMqttTopicsModal() {
            // If we have a cached password, skip the prompt
            var cached = getCachedMasterPassword();
            if (cached) {
                _mqttTopicsPassword = cached;
                openMqttTopicsModal();
            } else {
                // Show password prompt first
                document.getElementById('mqttTopicsPwPrompt').value = '';
                document.getElementById('mqttTopicsPwError').style.display = 'none';
                document.getElementById('mqttTopicsPasswordModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                document.getElementById('mqttTopicsPwPrompt').focus();
            }
        }

        function closeMqttTopicsPwPrompt() {
            document.getElementById('mqttTopicsPasswordModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function verifyMqttTopicsPassword() {
            var password = document.getElementById('mqttTopicsPwPrompt').value;
            var errorEl = document.getElementById('mqttTopicsPwError');
            var btn = document.getElementById('mqttTopicsPwBtn');
            if (!password) {
                errorEl.textContent = 'Password is required.';
                errorEl.style.display = 'block';
                return;
            }
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            errorEl.style.display = 'none';
            fetch('/api/mqtt/topics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ master_password: password, verify_only: true })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                btn.textContent = 'Unlock';
                if (data.success || data.verified) {
                    cacheMasterPassword(password);
                    _mqttTopicsPassword = password;
                    closeMqttTopicsPwPrompt();
                    openMqttTopicsModal();
                } else {
                    errorEl.textContent = data.error || 'Invalid password.';
                    errorEl.style.display = 'block';
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = 'Unlock';
                errorEl.textContent = 'Network error.';
                errorEl.style.display = 'block';
            });
        }

        // Handle Enter key in password prompt
        document.getElementById('mqttTopicsPwPrompt').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyMqttTopicsPassword();
        });

        function openMqttTopicsModal() {
            document.getElementById('mqttTopicsError').style.display = 'none';
            renderFieldToggles();

            // Load current topic settings
            fetch('/api/mqtt/topics')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.topics) {
                        var topics = data.topics;
                        TOPIC_GROUPS.forEach(function(g) {
                            if (topics[g]) {
                                document.getElementById('topicEnabled_' + g).checked = topics[g].enabled !== false;
                                document.getElementById('topicInterval_' + g).value = topics[g].interval || GROUP_DEFAULTS[g].interval;
                                updateTopicToggleVisual(g);
                                // Per-field toggles
                                if (GROUP_FIELDS[g] && topics[g].fields) {
                                    var fields = topics[g].fields;
                                    GROUP_FIELDS[g].forEach(function(f) {
                                        var el = document.getElementById('field_' + f);
                                        if (el) el.checked = fields[f] !== false;
                                    });
                                }
                            }
                        });
                        // ICCID fields
                        if (topics.heartbeat) {
                            document.getElementById('iccid_enabled').checked = topics.heartbeat.iccid_enabled === true;
                            document.getElementById('iccid_value').value = topics.heartbeat.iccid || '';
                            updateIccidToggleVisual();
                        }
                    }
                    // Settings response fields
                    if (data.settings_fields) {
                        SETTINGS_FIELDS.forEach(function(f) {
                            var el = document.getElementById('field_' + f);
                            if (el) el.checked = data.settings_fields[f] !== false;
                        });
                    }
                    updateAllFieldVisuals();
                })
                .catch(function() {
                    TOPIC_GROUPS.forEach(function(g) { updateTopicToggleVisual(g); });
                    updateAllFieldVisuals();
                    updateIccidToggleVisual();
                });

            document.getElementById('mqttTopicsModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            document.getElementById('mqttTopicsPassword').focus();
        }

        function closeMqttTopicsModal() {
            document.getElementById('mqttTopicsModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function toggleIccid() {
            var cb = document.getElementById('iccid_enabled');
            cb.checked = !cb.checked;
            updateIccidToggleVisual();
        }

        function updateIccidToggleVisual() {
            var on = document.getElementById('iccid_enabled').checked;
            var track = document.getElementById('iccidTrack');
            var thumb = document.getElementById('iccidThumb');
            track.style.background = on ? 'var(--button-success-bg)' : '#ccc';
            thumb.style.left = on ? '19px' : '3px';
        }

        function toggleTopicEnabled(topic) {
            var cb = document.getElementById('topicEnabled_' + topic);
            cb.checked = !cb.checked;
            updateTopicToggleVisual(topic);
        }

        function updateTopicToggleVisual(topic) {
            var on = document.getElementById('topicEnabled_' + topic).checked;
            var track = document.getElementById('topicTrack_' + topic);
            var thumb = document.getElementById('topicThumb_' + topic);
            track.style.background = on ? 'var(--button-success-bg)' : '#ccc';
            thumb.style.left = on ? '23px' : '3px';
        }

        function toggleField(field) {
            var cb = document.getElementById('field_' + field);
            cb.checked = !cb.checked;
            updateFieldToggleVisual(field);
        }

        function updateFieldToggleVisual(field) {
            var el = document.getElementById('field_' + field);
            if (!el) return;
            var on = el.checked;
            var track = document.getElementById('fieldTrack_' + field);
            var thumb = document.getElementById('fieldThumb_' + field);
            if (track) track.style.background = on ? 'var(--button-success-bg)' : '#ccc';
            if (thumb) thumb.style.left = on ? '19px' : '3px';
        }

        function updateAllFieldVisuals() {
            for (var group in GROUP_FIELDS) {
                GROUP_FIELDS[group].forEach(function(f) { updateFieldToggleVisual(f); });
            }
            SETTINGS_FIELDS.forEach(function(f) { updateFieldToggleVisual(f); });
        }

        function saveMqttTopics() {
            var password = _mqttTopicsPassword;
            var errorEl = document.getElementById('mqttTopicsError');
            var btn = document.getElementById('mqttTopicsSaveBtn');

            // Validate all intervals
            var topicsPayload = {};
            for (var i = 0; i < TOPIC_GROUPS.length; i++) {
                var g = TOPIC_GROUPS[i];
                var interval = parseFloat(document.getElementById('topicInterval_' + g).value);
                if (isNaN(interval) || interval < 0.5 || interval > 300) {
                    errorEl.textContent = g.charAt(0).toUpperCase() + g.slice(1) + ' interval must be between 0.5 and 300 seconds.';
                    errorEl.style.display = 'block';
                    return;
                }
                var entry = {
                    enabled: document.getElementById('topicEnabled_' + g).checked,
                    interval: interval
                };
                // Collect per-field states
                if (GROUP_FIELDS[g]) {
                    var fields = {};
                    GROUP_FIELDS[g].forEach(function(f) {
                        fields[f] = document.getElementById('field_' + f).checked;
                    });
                    entry.fields = fields;
                }
                topicsPayload[g] = entry;
            }
            // Add ICCID to heartbeat
            topicsPayload.heartbeat.iccid_enabled = document.getElementById('iccid_enabled').checked;
            topicsPayload.heartbeat.iccid = document.getElementById('iccid_value').value.trim();

            // Collect settings response field states
            var settingsFields = {};
            SETTINGS_FIELDS.forEach(function(f) {
                settingsFields[f] = document.getElementById('field_' + f).checked;
            });

            btn.disabled = true;
            btn.textContent = 'Saving...';
            errorEl.style.display = 'none';

            fetch('/api/mqtt/topics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    master_password: password,
                    topics: topicsPayload,
                    settings_fields: settingsFields
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                btn.disabled = false;
                btn.textContent = 'Save';
                if (data.success) {
                    cacheMasterPassword(password);
                    closeMqttTopicsModal();
                    showSuccess('MQTT topic settings saved.');
                } else {
                    errorEl.textContent = data.error || 'Failed to save topic settings.';
                    errorEl.style.display = 'block';
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.textContent = 'Save';
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.style.display = 'block';
            });
        }

        // Load config and security status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadSecurityStatus();
            loadMqttStatus();
        });
    </script>
    <script src="/js/theme.js"></script>
    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(function(){});
    }
    </script>
</body>
</html>
